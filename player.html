<!DOCTYPE html>
<html lang="it">
<head>
	<meta charset="utf-8">
	<title>Player</title>
	<link href="//netdna.bootstrapcdn.com/bootstrap/3.0.0/css/bootstrap.min.css" rel="stylesheet" id="bootstrap-css"> <!--codice boostrap per attivare le funzionalità bootstrap-->
	<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css">
	<link rel="icon" type="image/png" sizes="16x16" href="/public/images/icons/site16x16.ico">

	<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.16.0/umd/popper.min.js"></script>
	<script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.4.1/js/bootstrap.min.js"></script>

	<!--Internal dipendecies-->
	<link rel="stylesheet" href="/public/css/chat.css">
	<script type="text/javascript">
		var player_id = null;
		var index = null;
		var next_index = 0;
		var storyJSON = null;
		var answer = "";
		var isChatOpen = false;
		$(document).ready(function () {
            // richiesta storia
            var url_string = window.location.href;
            var url = new URL(url_string);
            var id = url.searchParams.get("id");
            $.ajax({
                type: 'GET',
                url: '/stories/' + id,
                success: function (data) {
                    storyJSON = data;
                    setPlayer(storyJSON);//
                },
                error: function (xhr, ajaxOptions, thrownError) {
                    alert(xhr.status + ' - ' + thrownError);
                }
            });
        });

		function setPlayer(data) {
			$.ajax({
				url: '/players/create_player',
				type: 'PUT',
				data: JSON.stringify(data),
				contentType: 'application/json',
				success: function (id) {
					player_id = id;
					setWindow();
				},
				error: function (xhr, ajaxOptions, thrownError) {
					alert(xhr.status + ' - ' + thrownError);
				}
			});
        }

		// Questa funzione serve a controllare l'eventuale input dell'attività attuale
		function checkInput() {
			let answer_data;
			let score = 0;
			let corrected_bool = true;
			let questionArray = [];
			let type = storyJSON.activities[index].input_type;
			next_index = storyJSON.activities[index].input.next_index;
			// storyJSON (è il file della storia trasformato in un'oggetto (JSON della storia)) . <--- serve per accedere ai campi delle storie
			// 'activities' è un'array [index] accedi all'attività attuale .input_type <--- è un campo dell'oggetto dell'array
            if (type == 'photo') {
				if (storyJSON.activities[index].input.evaluation_type == 'evaluator') {
					corrected_bool = false;
				}
			}
			else if (type == 'number') {
				answer = $('#input-num').val();
				if (storyJSON.activities[index].input.evaluation_type == 'correct') {
					//Controllo se esiste un intervallo corretto di risposte che contiene quella data
					storyJSON.activities[index].input.correct_options.forEach(function (option) {
						if (answer >= option.from && answer <= option.to) {
							score = option.points;
						}
					});
					//Se la risposta è sbagliata
					if (score == 0) {
                        if (storyJSON.activities[index].input.wrong_stay) {
							next_index = index;
						} else {
                            next_index = (storyJSON.activities[index].input.wrong_next_index || next_index);
						}
					}
				} else {
					//Evaluation_type == evaluator
					corrected_bool = false;
				}
			}
			else if (type == 'text') {
				answer = $('input-text').val();
				if (storyJSON.activities[index].input.evaluation_type == 'correct') {
					storyJSON.activities[index].input.correct_options.forEach((option) => {
						if (answer.toLowerCase().replace(' ', '') == option.text.toLowerCase().replace(' ', '')) {
							score = option.points;
						}
					});
					if (score == 0) {
                        if (storyJSON.activities[index].input.wrong_stay) {
							next_index = index;
						} else {
							next_index = (storyJSON.activities[index].input.wrong_next_index || next_index);
						}
					}
				} else {
					//Eval_type = evaluator
					corrected_bool = false;
					next_index = storyJSON.activities[index].input.next_index;
				}
			} 
            let mission_index = storyJSON.activities[next_index].mission_index;
            let mission_name;
            if (mission_index) { mission_name = storyJSON.missions[mission_index].name; } else { mission_name = (next_index == 1 ? 'Fine' : 'Inizio'); }

            //Costruisce l'array della domanda posta al player
            storyJSON.activities[index].contents.forEach(function (elem) {
                if (elem.type == 'text') {
                    questionArray.push({
                        type: 'text',
                        content: elem.text
                    });
                }
                if (elem.type == 'video') {
                    questionArray.push({
                        type: 'video',
                        content: {
                            url: elem.url,
                            descr: elem.description
                        }
                    });
                }
                if (elem.type == 'image') {
                    questionArray.push({
                        type: 'image',
                        content: {
                            url: elem.url,
                            descr: elem.description
                        }
                    });
                }
            });
            answer_data = {
                mission_name: mission_name,
				activity_name: storyJSON.activities[next_index].name,
				corrected: corrected_bool,
				question: questionArray,
				input_type: type,
                answer: answer,
				comment: '',
				quest_score: Number(score)
			};
			sendAnswerToServer(answer_data);
		}
		//Funzione per mandare il descrittore dell'attività completata al server ed aggiungerlo al file del player
		function sendAnswerToServer(answer_data) {
			console.log(answer_data);
			$.ajax({
				url: '/players/add_answer/player' + player_id,
				type: 'PUT',
				contentType: 'application/json',
				data: JSON.stringify(answer_data),
				success: function (data) {},
                error: function (xhr, ajaxOptions, thrownError) {
                    alert(xhr.status + ' - ' + thrownError);
                }
			});
		}
		// Questa funzione serve a impostare la finestra per la prossima attività
		function setWindow() {
			$('h1').text('(' + storyJSON.name + ')');
			let mission_index = storyJSON.activities[next_index].mission_index;
			$('#nome-attivita').text(storyJSON.activities[next_index].name);
			if (mission_index != null) {
               $('#nome-missione').text(storyJSON.missions[mission_index].name);
            }
			$('.testo-attivita').empty();
			$('.to_del').remove();
			storyJSON.activities[next_index].contents.forEach(function (elem) {
                if (elem.type == 'text') {
                    $('.testo-attivita').append(elem.text + '<br>');
                }
                if (elem.type == 'video') {
					var video = document.createElement('video');
                    var source = document.createElement('source');
					source.setAttribute('src', elem.url);
                    video.setAttribute('width', '400');
                    video.setAttribute('controls', '');
					video.appendChild(source);
					video.setAttribute('class', 'to_del');
					video.setAttribute('alt', elem.description);
                    $('.video').append(video);
                }
                if (elem.type == 'image') {
					var image = document.createElement('img');
                    image.setAttribute('src', elem.url);
                    image.setAttribute('alt', elem.description);
					image.setAttribute('width', '400');
                    image.setAttribute('class', 'to_del');
                    $('.img').append(image);
                }
			});
			$('#footer').empty();
            if (storyJSON.activities[next_index].input_type == 'photo') {
                $('#footer').append('<label for="input-immagine" class="input custom-file-upload">'
                    + '<span class="glyphicon glyphicon-cloud-upload"></span> Carica Foto</label >'
					+ '<input id="input-immagine" type="file"/>');
				$('label[for="input-immagine"]').focus();

            } else if (storyJSON.activities[next_index].input_type == 'number') {
				$('#footer').append('<input id="input-num" class="input" type="number">');
                $('#input-num').focus();
			} else if (storyJSON.activities[next_index].input_type == 'text') {

				$('#footer').append(
					`<div class="inner-addon left-addon">
							 <b class= "glyphicon glyphicon-pencil"></b>
						<input type="text" id=input-text class="form-control" placeholder="Risposta"/>		  
					</div>`);
                $('#input-text').focus();
			}
            
            $('#footer').append('<button id="bottone-avanti" class="input" type="button" class="btn btn-light">Avanti</button>');
			let date = new Date();
			let hour = date.getHours();
			let minutes = date.getMinutes();
			index = next_index;
            setCurrentQuest(hour, minutes);

		}
		function setCurrentQuest(h, m) {
			let mission_index = storyJSON.activities[index].mission_index;
			let mission_name = '';
			if (mission_index != null) {
				mission_name = storyJSON.missions[mission_index].name;
			}
			let data = {
				minutes: m,
				hour: h,
				activity: storyJSON.activities[index].name,
				mission: mission_name
			};
			$.ajax({
				url: '/players/set_current_quest/player' + player_id,
				type: 'PUT',
				contentType: 'application/json',
				data: JSON.stringify(data),
				success: function () {},
				error: function (xhr, ajaxOptions, thrownError) {
                    alert(xhr.status + ' - ' + thrownError);
                }
			});
        }
		$(document).on('click', '#bottone-avanti', function () {
			if (isInputValid()) {
				if (storyJSON.activities[index].input_type == 'photo') {
					//In caso di success di uploadFile vengono invocate check input e setWindows
					uploadFile($('#input-immagine')[0].files[0]);
				} else {
					checkInput();
					setWindow();
				}
			} else {
				//Non accade nulla
			}
		});
		function isInputValid() {
			let input_type = storyJSON.activities[index].input_type;
			console.log(input_type);
			switch (input_type) {
				case 'photo':
					if ($('#input-immagine')[0].files.lenght == 0)
						return false;
					else return true;
                case 'none':
                    return true;
				default:
					if ($('#input-num').val() || ($('#input-text').val()))
						return true;
					else return false;
			}
        }
		//Evento per andare avanti fra le attività con invio
		$(document).on('keypress', function (key) {
			if (key.which == 13) {
				if (!isChatOpen) {
					$('#bottone-avanti').click();
				}
			}
		});
		//Evento per inviare il messaggio in chat con invio
		$(document).on('keydown', '#new_msg_text', function (event) {
			if (event.which == 13) {
				event.preventDefault();
				$('#send-msg').click();
			}
		});
		//Evento per mostrare una preview del file selezionato
		$(document).on('change', '#input-immagine', function () {
			$('#preview').remove();
			let img = document.createElement('img');
			img.setAttribute('alt','Your selected image');
			img.setAttribute('src', (window.URL ? URL : webkitURL).createObjectURL($('#input-immagine')[0].files[0]));
			img.setAttribute('id', 'preview');
			document.getElementById('footer').insertBefore(img, document.getElementById('bottone-avanti'));
		});

        function uploadFile(file) {
			let fd = new FormData();
            fd.append(file.name, file);
			let path = '/players/upload_photo/' + 'player' + player_id + '/' + index;
            $.ajax({
				accepts: 'application/json',
				url: path,
                data: fd,
                type: 'POST',
                contentType: false,
                processData: false,
                success: function (data) {
                	answer = data.url;
                	checkInput();
                	setWindow();
				},
                error: function (xhr, ajaxOptions, thrownError) {
                    alert(xhr.status + ' - ' + thrownError);
                }
            });
        }


		/**** Funzioni per la chat ****/
        //Sets the layout of the chat messages
        function setChatView(data) {
        	$('#chat-user').empty();
        	$('#chat-msgs').empty();
        	document.getElementById("chat").style.display = "block";

        	$('#chat-user').append('<div class="glyphicon glyphicon-comment"></div><p id="chat-title">Valutatore</p>');
        	data.chat.forEach((chatlog) => {
        		if ((chatlog.auth.localeCompare("Valutatore")) != 0) {
        			$('#chat-msgs').append('<div class="row msg_container base_sent"><div class="col-md-10 col-xs-10"><div class="messages sent-msgs msg_sent"><p>' +
					 chatlog.text + '</p><time>Tu - ' + chatlog.hour + ':' + chatlog.mins + '</time></div></div></div>');
        		} else {
        			$('#chat-msgs').append('<div class="row msg_container base_receive <div class="col-md-10 col-xs-10"><div class="messages msg_receive"><p>' +
					 chatlog.text + '</p> <time>' + (data.username ? data.username : ('Player ' + data.id)) + ' - ' + chatlog.hour + ':' + chatlog.mins + '</time></div></div></div>');
        		}
        	});
        }
        //Open the pop-up chat with the selected player
        function openChat(id) {
        	isChatOpen = true;
        	$.ajax({
        		url: '/players/' + id,
        		success: function (data) {
        			setChatView(data);
        			markAsSeen(id);
        			scrollToBottom();
        			$('#new_msg_text').focus();
        		},
        		error: function (xhr, ajaxOptions, thrownError) {
        			alert(xhr.status + ' - ' + thrownError);
        		}
        	});
        }
        //Close the pop-up chat
        function closeChat() {
        	isChatOpen = false;
        	document.getElementById("chat").style.display = "none";
        	currentChatPlayerId = null;
        }
        //Send chat message to the server
        function sendMsg() {
        	var str = $("#new_msg_text").val();
        	$('#new_msg_text').val('');
        	if (str) {
        		let date = new Date();
        		var hrs = String(date.getHours());
        		var min = date.getMinutes();
        		min = (min < 10 ? ("0" + String(min)) : (String(min)));
        		var msg = {
        			hour: hrs,
        			mins: min,
        			text: str,
        			auth: "player" + player_id,
        			seen: false
        		};
        		let id = 'player' + player_id;
        		$.ajax({
        			url: '/players/' + id,
        			type: 'POST',
        			contentType: 'application/json',
        			data: JSON.stringify(msg),

        			success: function (data) {
        				openChat(id);
        				$('#new_msg_text').focus();
        			},
        			error: function (xhr, ajaxOptions, thrownError) {
        				alert(xhr.status + ' - ' + thrownError);
        			}
        		});
        	}
        }
		//Change the state of the current chat last messages to 'seen'
        function markAsSeen(id) {
        	$.ajax({
        		url: '/players/mark_as_seen/' + id,
        		type: 'POST',
        		contentType: 'application/json',
        		data: JSON.stringify({ author: 'player'+player_id}),
        		success: function () {
        		},
        		error: function (xhr, ajaxOptions, thrownError) {
        			alert(xhr.status + ' - ' + thrownError);
        		}
        	});
        }
        //Scroll to the last received message in the current chat
        function scrollToBottom() {
        	let chatVBox = document.getElementById('chat-msgs');
        	chatVBox.scrollTop = chatVBox.scrollHeight;
        }
        //Event to open chat with selected player
        $(document).on('click', '#chat-button', function (event) {
        	openChat('player' + player_id);
        });
	</script>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<style type="text/css">
		@font-face {
			font-family: 'All The Roll';
			src: url('public/fonts/AllTheRollPersonalUse.woff2') format('woff2'), url('public/fonts/AllTheRollPersonalUse.woff') format('woff');
			font-weight: normal;
			font-style: normal;
			font-display: swap;
		}
        /*TAg*/
        img {
            object-fit: contain;
            width: 100%;
            height: auto;
        }

        video {
            width: 100%;
        }

        body {
            background-color: #007bff;
        }
		h1 {
			font-size: 11vh;
			text-align: center;
			color: white;
			font-family: "All The Roll";
			line-height: .9;
		}
		/*classi e id*/
		#div-grande {
			border: 3px #007bff solid;
			height: 70vh;
			overflow-y: auto;
			background-color: white;
			width: 80%;
			margin: auto;
			padding: 1vh;
			border-radius: 2vh;
		}
		.bottonechat {
			font-size: 3vh;
			margin-right: 0.5vw;
			border-radius: 0;
			border: 1px solid black;
			border-top: 0;
			border-left: 0;
		}
		#nome-attivita {
			text-align: center;
			font-size: 2.5vh;
			font-family: 'Helvetica Neue LT Std';
		}

		#nome-missione {
			text-align: center;
			font-size: 4vh;
			font-family: 'Helvetica Neue LT Std';
			margin-bottom: 0.5vh;
		}

		.testo-attivita {
			margin-left: 1.5vh;
			margin-right: 1.5vh;
			margin-top: .5vh;
			font-size: 2.5vh;
			text-align: justify;
			font-family: 'Helvetica Neue LT Std';
		}
		.img {
			text-align: center;
			vertical-align: middle;
			border-style: none;
		}
        /*spazio che contiene gli input*/
        #footer {
            width: 100%;
            text-align: center;
        }
		/*INPUT: */
		.input { /*tutti gli input*/
			margin: 1.5vh;
			font-size: 3vh;
			border: black solid 1px;
		}
		/*input delle risposte*/
		/*placeholder è la scritta inside all'input*/
		#input-text::placeholder {
			font-weight: bold;
			font-style: italic;
		}
        #bottone-avanti {
            border: 1px black solid;
            font-size: 2.5vh;
            border-radius: 0.5vh;
            font-weight: bold;
			margin: 2vh;
        }
        /*INPUT TEXT + GLYPHICON*/
        /*Bootstrap layout per avere l'icona dentro all'input*/
        .inner-addon {
            position: relative;
            width: 20vh;
            margin-left: auto;
            margin-right: auto;
            display: inline-block;
        }
        .glyphicon-pencil.glyphicon-pencil:before {
            bottom: 0.5vh;
            position: relative;
        }
        /* style icon */
        .inner-addon .glyphicon {
            position: absolute;
            padding: 10px;
        }
        /* align icon */
        .left-addon .glyphicon {
            left: 0px;
        }
        /* add padding  */
        .left-addon input {
            padding-left: 30px;
        }
        /*UPLOAD dei FILE (immagini)*/
        .custom-file-upload {
            background: white;
            display: inline-block;
            cursor: pointer;
            padding: 1px 6px;
            border: 1px black solid;
            font-weight: bold;
            font-size: 2.5vh;
            border-radius: 0.5vh;
        }
		/*per nascondere l'input dell'immagine xkè se no è un obrobrio*/
        input[type="file"] {
            display: none;
        }
		/*preview dell'immagine caricata*/
		#preview {
			width:10vw;
			position: absolute;
			margin: auto;
			left: 0;
		}	
	</style>
</head>
<body>
	<div id="generico">
		<button type="button" id="chat-button" class="btn btn-light bottonechat">Chat</button>
	</div>
	<h1></h1>
	<div id="div-grande">
		<!--TITOLO MISSIONE-->
		<div id="nome-missione">
		</div>
		<div id="nome-attivita">
		</div>
		<!--TESTO ATTIVITA VISUALIZZATA-->
		<div class="testo-attivita">
		</div>
		<!--SPAZIO VIDEO-->
		<div class="div-grande-video">
			<div class="video">
			</div>
		</div>
		<!--SPAZIO IMMAGINE-->
		<div class="div-grande-img">
			<div class="img"></div>
		</div>
	</div>
	<div id="footer">
	</div>
	<!--CHAT-->
	<div class="chat-popup" id="chat">
		<form autocomplete="off" class="form-container">
			<div class="container">
				<div class="col-sm-8">
					<div class="chatbody">
						<div class="panel panel-primary">
							<div class="panel-heading top-bar">
								<div class="col-md-4 col-xs-4" style="text-align: right;">
									<a onclick="closeChat()"><span class="glyphicon glyphicon-remove icon_close" data-id="chat_window_1"></span></a>
								</div>
								<div class="col-md-8 col-xs-8">
									<p class="panel-title" id="chat-user"><!--Nome utente chat--></p>
								</div>
							</div>
							<div id="chat-msgs" class="panel-body msg_container_base">
								<!--MESSAGGI-->
							</div>
							<div class="panel-footer">
								<div class="input-group">
									<input id="new_msg_text" type="text" autocomplete="off" class="form-control input-sm chat_input" placeholder="Scrivi il tuo messaggio..." />
									<a id="send-msg" class="btn btn-info btn-sm" onclick="sendMsg()">
										<span class="glyphicon glyphicon-send"></span> Send
									</a>
								</div>
							</div>
						</div>
					</div>
				</div>
			</div>
		</form>
	</div>
</body>
</html>