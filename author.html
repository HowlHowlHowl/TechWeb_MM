<!DOCTYPE html>
<html lang="it">
<head>
	<meta charset="UTF-8">
	<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css">
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.16.0/umd/popper.min.js"></script>
	<script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.4.1/js/bootstrap.min.js"></script>
    
    <style>
    .editable-name {
        background-color: transparent;
        border: 0px;
        font-weight: bold;
        font-size: 20pt;
        display: inline-block;
        width: 100%;
    }
    
    
    .activities-div {
        padding: 15px;
    }
    
    .editable-name-div {
        overflow: hidden;
    }
    
    .story-div {
        padding: 5px;
    }
    
    .mission-div {
        background-color: #a8c5ff;
        margin: 10px;
    }
    
    .activity-div {
        margin: 10px;
        background-color: #87b3ff;
    }
    
    .mission-name {
        font-size: 15pt;
    }
    
    .activity-name {
        font-size: 13pt;
    }
    
    
    </style>
    
	<script type="text/javascript">
    var selectedStoryButton = null;
    var loadedStory = null;
    var editorDirty = false;
    
    function modalSave() {
        saveSelectedStory();
    }
    
    function modalDiscard() {
        editorDirty = false;
        clearSelectedStory();
    }
    
    function editorNameChange(element) {
        if(loadedStory.name != element.value) {
            loadedStory.name = element.value;
            editorDirty = true;
        }
    }
    
    function editorAccessibleChange(element) {
        loadedStory.accessible = element.checked;
        editorDirty = true;
    }
    
    function addActivityElement(activity, container, mission) {
        let activity_div = $($("#template-activity").html());
        
        linkInputToProperty(activity, "name", activity_div.find(".activity-name"));
        
        let del = activity_div.find(".activity-del");
        del.on("click", () => {
            let index = mission.activities.indexOf(activity);
            if(index != -1) {
                mission.activities.splice(index, 1);
            }
            activity_div.remove();
            editorDirty = true;
        });
        
        let copy = activity_div.find(".activity-copy");
        copy.on("click", () => {
        });
        
        activity_div.appendTo(container);
    }
    
    function editorNewActivity(mission, container) {
        editorDirty = true;
        let activity = {
            name: "Nuova attività",
            challenge: true
        };
        
        mission.activities.push(activity);
        addActivityElement(activity, container, mission);
    }
    
    
    function linkInputToProperty(object, name, input) {
        input.attr("value", object[name]);
        input.on("change", () => {
            editorDirty = true;
            object[name] = input.val();
        });
    }
    
    function addMissionElement(mission) {
        let mission_div = $($("#template-mission").html());
        
        linkInputToProperty(mission, "name", mission_div.find(".mission-name"));
        
        let del = mission_div.find(".mission-del");
        del.on("click", () => {
            let index = loadedStory.missions.indexOf(mission);
            if(index != -1) {
                loadedStory.missions.splice(index, 1);
            }
            
            mission_div.remove();
            editorDirty = true;
        });
        
        let copy = mission_div.find(".mission-copy");
        copy.on("click", () => {
            console.log("copy");
        });
        
        let activities_div = mission_div.find(".activities-div");
        mission.activities.forEach((a) => addActivityElement(a, activities_div, mission));
        
        let new_activity = mission_div.find(".new-activity");
        new_activity.on("click", () => editorNewActivity(mission, activities_div));
        
        mission_div.appendTo("#editor-missions");
    }
    
    function editorNewMission() {
        editorDirty = true;
        let mission = {
            name: "Nuova missione",
            activities: []
        };
        loadedStory.missions.push(mission);
        addMissionElement(mission);
    }
    
    function clearSelectedStory() {
        if(selectedStoryButton) {
            selectedStoryButton.removeClass("active");
        }
        selectedStoryButton = null;
        loadedStory = null;
        editorDirty = false;
        $("#editor-placeholder").removeClass("d-none");
        $("#editor-area").addClass("d-none");
    }
    
    function selectStory(id) {
        $.ajax({
            accepts: 'application/json',
            url: '/stories/' + id,
            success: function(data) {
                editorDirty = false;
                loadedStory = data;
                $("#editor-placeholder").addClass("d-none");
                $("#editor-area").removeClass("d-none");
                $("#editor-name").val(loadedStory.name);
                $("#editor-accessible").prop("checked", loadedStory.accessible);
                
                $("#editor-missions").empty();
                loadedStory.missions.forEach((m) => {
                    addMissionElement(m);
                });
                
            },
            error: function (xhr, ajaxOptions, thrownError) {
                alert(xhr.status + ' - ' + thrownError);
            }
        });
    }
    
    
    function addStoryElement(s) {
        let story_div = $($("#template-story").html());
        
        let item = story_div.find(".list-group-item");
        item.text(s.name);
        item.on("click", () => {
            if(editorDirty) {
                $("#save-modal").modal();
                return;
            }
            
            if(selectedStoryButton) {
                selectedStoryButton.removeClass("active");
            }
            selectedStoryButton = item;
            item.addClass("active");
            selectStory(s.id);
        });
        
        if(loadedStory && loadedStory.id == s.id) {
            selectedStoryButton = item;
            item.addClass("active");
        }
        
        let qr = story_div.find(".story-qr");
        
        let del = story_div.find(".story-del");
        del.on("click", (event) => {
            $("#modal-delete-message").html("Sicuro di voler eliminare la storia: <b>" + s.name + "</b>?");
            $("#modal-delete-button").attr("delete-id", s.id);
            $("#delete-modal").modal();
        });
        
        
        let swap = story_div.find(".story-swap");
        swap.on("click", () => actionOnStory(s.id, s.published ? "archive" : "publish"));
        
        let dup = story_div.find(".story-dup");
        dup.on("click", () => actionOnStory(s.id, "duplicate"));
        
        if(s.published) {
            $('#stories-published').append(story_div);
        } else {
            $('#stories-archived').append(story_div);
        }
    }
    
    function updateStories() {
        $.ajax({
            accepts: 'application/json',
            url: '/stories',
            success: function(data) {
                $('#stories-published').empty();
                $('#stories-archived').empty();
                
                data.forEach(addStoryElement);
            },
            error: function (xhr, ajaxOptions, thrownError) {
                alert(xhr.status + ' - ' + thrownError);
            }
        });
    }
    
    function newStory(published)
    {
        let story = {
            name: "Nuova storia",
            accessible: false,
            published: published,
            missions: 
            [
            ]
        };
        
        $.ajax({
            url: '/stories',
            type: 'POST',
            contentType: 'application/json',
            data: JSON.stringify(story),
            
            success: function(data) {
                updateStories();
            },
            error: function (xhr, ajaxOptions, thrownError) {
                alert(xhr.status + ' - ' + thrownError);
            }
        });
    }
    
    function saveSelectedStory()
    {
        if(loadedStory)
        {
            editorDirty = false;
            let id = loadedStory.id;
            $.ajax({
                url: '/stories/' + id,
                type: 'PUT',
                contentType: 'application/json',
                data: JSON.stringify(loadedStory),
                
                success: function(data) {
                    updateStories();
                },
                error: function (xhr, ajaxOptions, thrownError) {
                    alert(xhr.status + ' - ' + thrownError);
                }
            });
        }
    }
    
    function actionOnStory(id, action) {
        console.log("Action: " + action + " on story: " + id);
        $.ajax({
            url: '/stories/' + id,
            type: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({ action: action}),
            
            success: function(data) {
                if(action == "delete" && loadedStory && loadedStory.id == id) {
                    clearSelectedStory();
                }
                updateStories();
            },
            error: function (xhr, ajaxOptions, thrownError) {
                alert(xhr.status + ' - ' + thrownError);
            }
        });
    }
    
    $(document).ready(function() {
        updateStories();
    });
    </script>
    
    <meta charset="utf-8"/>
    <title>Author</title>
</head>
<body>
    <h1>Author</h1>
    
    <!-- Area principale -->
    <div class="row p-3">
        <!-- Area gestione storie -->
        <div class="col-3">
            <h4>Pubblicate</h4>
            <button class="btn btn-primary mb-1 btn-block" onclick="newStory(true)">Crea nuova storia</button>
            <div class="list-group" id="stories-published">
            
            </div> <div class="m-3"></div>
            
            <h4>Archiviate</h4>
            <button class="btn btn-primary mb-1 btn-block" onclick="newStory(false)">Crea nuova storia</button>
            
            <div class="list-group" id="stories-archived">
            </div>
        </div>
        
        
        <!-- Placeholder per area editor -->
        <div class="col-9" id="editor-placeholder">
            <p>Seleziona una storia da modificare</p>
        </div>
        
        <!-- Area editor -->
        <div class="col-9 d-none" id="editor-area" style="background-color: #d2e7fc">
            <input type="text" class="editable-name" id="editor-name" onchange="editorNameChange(this)">
            <div class="form-check">
               <input type="checkbox" class="form-check-input" id="editor-accessible" onchange="editorAccessibleChange(this)">
               <label class="form-check-label" for="editor-accessible">Accessibile</label>
            </div>
            
            <hr>
            <div id="editor-missions">
            </div>
            
            <button class="btn btn-primary" onclick="editorNewMission()">Nuova missione</button>
            <button class="btn btn-primary float-right btn-lg" onclick="saveSelectedStory()">Salva</button>
        </div>
        
    </div>
    
    <!-- Finestra modale di salvataggio -->
    <div class="modal" id="save-modal" tabindex="-1" role="dialog">
      <div class="modal-dialog" role="document">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Modifiche non salvate</h5>
            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
              <span aria-hidden="true">&times;</span>
            </button>
          </div>
          <div class="modal-body">
            <p>Salvare le modifiche effettuate?</p>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-primary" data-dismiss="modal" onClick="modalSave()">Salva</button>
            <button type="button" class="btn btn-primary" data-dismiss="modal" onClick="modalDiscard()">Scarta</button>
            <button type="button" class="btn btn-secondary" data-dismiss="modal">Annulla</button>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Finestra modale di eliminazione -->
    <div class="modal" id="delete-modal" tabindex="-1" role="dialog">
      <div class="modal-dialog" role="document">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Eliminazione</h5>
            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
              <span aria-hidden="true">&times;</span>
            </button>
          </div>
          <div class="modal-body">
            <p id="modal-delete-message"></p>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-primary" data-dismiss="modal" id="modal-delete-button" onclick="actionOnStory($(this).attr('delete-id'), 'delete')">Elimina</button>
            <button type="button" class="btn btn-secondary" data-dismiss="modal">Annulla</button>
          </div>
        </div>
      </div>
    </div>
    
    
    <!-- template per widget della storia -->
    <template id="template-story">
        <div class="btn-group story-div" role="group">
            <button class="list-group-item list-group-item-action"></button>
            <button class="btn btn-outline-primary btn-sm story-qr" title="Genera QRCode">QR</button>
            <button class="btn btn-outline-primary btn-sm story-del" title="Elimina">Del</button>
            <button class="btn btn-outline-primary btn-sm story-swap" title="Pubblica/Archivia">Swap</button>
            <button class="btn btn-outline-primary btn-sm story-dup" title="Duplica">Dup</button>
        </div>
    </template>
    
    <!-- template per editor attività -->
    <template id="template-activity">
        <div class="activity-div">
            <div class="btn-group float-right" role="group">
                <button class="btn btn-info btn-sm activity-del" title="Elimina">Del</button>
                <button class="btn btn-info btn-sm activity-copy" title="Copia">Copy</button>
            </div>
            
            <div class="editable-name-div">
                <input type="text" class="editable-name activity-name">
            </div>
        </div>
    </template>
    
    <!-- template per editor missioni -->
    <template id="template-mission">
        <div class="mission-div">
            <div class="btn-group float-right" role="group">
                <button class="btn btn-secondary btn-sm mission-del" title="Elimina">Del</button>
                <button class="btn btn-secondary btn-sm mission-copy" title="Copia">Copy</button>
            </div>
            
            <div class="editable-name-div">
                <input type="text" class="editable-name mission-name">
            </div>
            
            <div class="activities-div">
            </div>
            
            <button class="btn btn-secondary btn-sm new-activity">Nuova attività</button>
        </div>
    </template>
    
</body>
</html>
